<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>供应商管理</title>
	<meta name="renderer" content="webkit">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="format-detection" content="telephone=no">
	<link rel="stylesheet" href="../resources/layui/css/layui.css" media="all" />
	<link rel="stylesheet" href="../resources/css/public.css" media="all" />
	<style type="text/css">
		.layui-btn {
		    height: 30px;
		    line-height: 30px;
		}
	</style>
</head>
<body class="childrenBody">
<!-- 模糊查询条件开始 -->
<fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
  <legend>查询条件</legend>
</fieldset>
<form class="layui-form" action="" style="text-align: center;" id="searchFrm">
	 <div class="layui-form-item">
    <div class="layui-inline">
      <label class="layui-form-label">供应商</label>
      <div class="layui-input-inline">
        <select id="seachProviderid" name="providerid"></select>
      </div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label">商品名称</label>
      <div class="layui-input-inline">
        <input type="text" name="goodsname" id="goodsname" autocomplete="off" placeholder="请输入商品名称" class="layui-input">
      </div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label">商品描述</label>
      <div class="layui-input-inline">
        <input type="tel" name="description" id="description" autocomplete="off" placeholder="请输入商品描述" class="layui-input">
      </div>
    </div>
    
  </div>
  
  <div class="layui-form-item">
    <div class="layui-inline">
      <label class="layui-form-label">生产批号</label>
      <div class="layui-input-inline">
        <input type="text" name="productcode" id="productcode" autocomplete="off" placeholder="请输入生产批号" class="layui-input">
      </div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label">批准文号</label>
      <div class="layui-input-inline">
        <input type="text" name="promitcode" id="promitcode" autocomplete="off" placeholder="请输入批准文号" class="layui-input">
      </div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label">商品包装</label>
      <div class="layui-input-inline">
        <input type="text" name="goodspackage" id="goodspackage" autocomplete="off" placeholder="请输入商品包装" class="layui-input">
      </div>
    </div>
  </div>
  
  <div class="layui-form-item" style="text-align: center; margin: 10px">
  	<div class="layui-inline">
	    <div class="layui-input-inline">
	      <button type="button" id="doSearch" class="layui-btn" lay-submit="" lay-filter="doSearch">查询</button>
	      <button type="reset" class="layui-btn layui-btn-primary">重置</button>
	    </div>
  	</div>
  </div>
  
</form>
<!-- 模糊查询条件结束 -->

<!-- 添加修改弹出层开始 -->
<div id="editGoods" style="display: none;">
	<form class="layui-form"  id="dataFrm" lay-filter="dataFrm" style="margin: 10px">
			<div class="layui-form-item">
			<div class="layui-inline">
				<label class="layui-form-label">选择供应商</label>
				<div class="layui-input-inline">
					<input type="hidden" name="id">
					<select name="providerid" id="providerid">
					</select>
				</div>
			</div>
			<div class="layui-inline">
				<label class="layui-form-label">商品名称</label>
				<div class="layui-input-inline">
					<input type="text" name="goodsname" lay-verify="required" placeholder="请输入商品名称"
						autocomplete="off" class="layui-input">
				</div>
			</div>
			<div class="layui-inline">
				<label class="layui-form-label">产地</label>
				<div class="layui-input-inline">
					<input type="text" name="produceplace" placeholder="请输入产地"
						autocomplete="off" class="layui-input">
				</div>
			</div>
			<div class="layui-inline">
				<label class="layui-form-label">规格</label>
				<div class="layui-input-inline">
					<input type="tel" name="size" autocomplete="off" placeholder="请输入规格类型"
						class="layui-input">
				</div>
			</div>
			<div class="layui-inline">
				<label class="layui-form-label">包装</label>
				<div class="layui-input-inline">
					<input type="text" name="goodspackage" autocomplete="off" placeholder="请输入包装"
						class="layui-input">
				</div>
			</div>
			<div class="layui-inline">
				<label class="layui-form-label">生产批号</label>
				<div class="layui-input-inline">
					<input type="text" name="productcode" placeholder="请输入生产批号"
						autocomplete="off" class="layui-input">
				</div>
			</div>
			<div class="layui-inline">
				<label class="layui-form-label">批准文号</label>
				<div class="layui-input-inline">
					<input type="tel" name="promitcode" placeholder="请输入批准文号"
						autocomplete="off" class="layui-input">
				</div>
			</div>
			<div class="layui-inline">
				<label class="layui-form-label">销售价格</label>
				<div class="layui-input-inline">
					<input type="text" name="price" lay-verify="required" placeholder="请输入销售价格"
						autocomplete="off" class="layui-input">
				</div>
			</div>
			<div class="layui-inline">
				<label class="layui-form-label">是否可用</label>
				<div class="layui-input-inline">
					<input type="radio" name="available" value="1" title="是" checked="">
					<input type="radio" name="available" value="0" title="否">
				</div>
			</div>
			<div class="layui-inline">
				<label class="layui-form-label">库存</label>
				<div class="layui-input-inline">
					<input type="text" name="number" placeholder="请输入库存数量"
						lay-verify="required|number" autocomplete="off"
						class="layui-input">
				</div>
			</div>
			<div class="layui-inline">
				<label class="layui-form-label">预警库存</label>
				<div class="layui-input-inline">
					<input type="text" name="dangernum" placeholder="请输入预警库存"
						lay-verify="required|number" autocomplete="off"
						class="layui-input">
				</div>
			</div>
		</div>
		<div class="layui-form-item layui-form-text">
			<label class="layui-form-label">商品描述</label>
			<div class="layui-input-block">
				<input placeholder="请输入商品描述" name="description"
					class="layui-input"></input>
			</div>
		</div>
		<div class="layui-form-item layui-form-text">
			<label class="layui-form-label">商品图片</label>
			<div class="layui-upload">
				<img class="layui-upload-img" width="100px" height="80px" id="goodsimg_img">
				<button type="button" class="layui-btn" id="goodspath">上传图片</button>
				<span id="goodsText"></span>
				<input type="hidden" name="goodsimg" id="goodsimg" class="layui-input">
			</div>
		</div>
		<div class="layui-form-item" style="text-align: center;">
			<button type="button" class="layui-btn" lay-submit="" lay-filter="doSubmit">提交</button>
			<button type="reset" class="layui-btn layui-btn-warm">重置</button>
		</div>

	</form>
</div>
<!-- 添加修改弹出层结束 -->


<!-- 数据表单开始 -->
<table  id="goodsdata" lay-filter="test"></table>
 
<div id="tabletoolbar" style="display: none;" lay-filter="tabletoolbar">
	<button class="layui-btn layui-btn-sm layui-btn-normal" lay-event="add">添加商品</button>
	<button class="layui-btn layui-btn-sm layui-btn-danger" lay-event="batchDelete">批量删除</button>
</div>

<div id="toolbar" style="display: none;" lay-filter="toolbar">
	<button class="layui-btn" lay-event="update"><i class="layui-icon ">&#xe642;</i></button>
	<button class="layui-btn layui-btn-danger" lay-event="delete"><i class="layui-icon">&#xe640;</i></button>
</div>
<!-- 数据表单结束 -->
 
<script src="../resources/layui/layui.js"></script>
<script>
	layui.use(['jquery','table','form','layer','upload'], function(){
	  var $ = layui.jquery;
	  var table = layui.table;
	  var form = layui.form;
	  var layer = layui.layer;
	  var upload = layui.upload;
	  
	  initProviderSelect($("#seachProviderid"));
	  //第一个实例
	  var tableIns = table.render({
	    elem: '#goodsdata'
	    ,cellMinWidth: 80
	    ,height: 'full-250'
	    ,url: '/goods/loadAllGoods' //数据接口
	    ,page: true //开启分页
	    , done: function(curr, count){
	    	layer.msg("欢迎来到商品管理");
	      }
	  	,limit:8
	  	,limits:[5,10,15,20,25,30,50]
	  	,toolbar:"#tabletoolbar"
	  	,defaultToolbar: ['filter', 'print']
	    ,cols: [ [ //表头
	       {type:'checkbox'}
	      ,{field: 'id', title: '商品ID',width:90, align:'center'}
	      ,{field: 'providerid', title: '供应商ID',width:90, align:'center',hide:true}
	      ,{field: 'goodsname', title: '商品名称',width:140,align:'center'}
	      ,{field: 'providername', title: '商品供应商',width:140,align:'center'}
	      ,{field: 'produceplace', title: '商品产地',width:90,align:'center'}
	      ,{field: 'size', title: '商品规格',width:90,align:'center'} 
	      ,{field: 'goodspackage', title: '商品包装',width:90,align:'center'} 
	      ,{field: 'productcode', title: '生产批号',width:90,align:'center'} 
	      ,{field: 'promitcode', title: '批准文号',width:90,align:'center'} 
	      ,{field: 'description', title: '商品描述',width:120,align:'center'} 
	      ,{field: 'price', title: '商品价格',width:90,align:'center'} 
	      ,{field: 'number', title: '商品库存',width:90,align:'center'} 
	      ,{field: 'dangernum', title: '预警库存',width:90,align:'center',templet:function(d){
	    	  return "<font color='red'>"+d.dangernum+"</font>"
	      }} 
	      ,{field: 'goodsimg', title: '商品图片',width:110,align:'center',templet:function(d){
	    	  return "<img width=40 height=40 src=/file/download?path="+d.goodsimg+" />";
	      }} 
	      ,{field:'available', width:180, title: '是否可用', width:100,templet:function(d){
	    	  return d.available==1?"<font color='green'>可用</font>":"<font color='red'>不可用</font>";
	      },align:'center'}
	      ,{title:'操作',width:180,	align:'center',toolbar:'#toolbar',fixed: 'right'}
	    ] ]
	  	,text: {
	  	    none: '亲！暂无相关数据' //默认：无数据。注：该属性为 layui 2.2.5 开始新增
	    }
	    
	  });
	  
	  $("#doSearch").click(function(){
		  var params =  $("#searchFrm").serialize();
		  tableIns.reload({url:"/goods/loadAllGoods?"+params});
	  });
	  
	  table.on('toolbar(test)', function(obj){
		  switch(obj.event){
		    case 'add':
		      toAddGoods();
		    break;
		    case 'batchDelete':
				var checkStatus = table.checkStatus('goodsdata');//test就是<table id="test">
		        
		        var data = checkStatus.data;
				//console.log(typeof checkStatus.data+"-->"+checkStatus.data.length);
		        var batchIds="";
		        var goodsimgs="";
		        for(var i=0;i<data.length;i++){
		        	batchIds += data[i].id+",";
		        	goodsimgs += data[i].goodsimg+",";
		        }
		        
		        var ids = batchIds.substring(0,batchIds.length-1);
		        var imgs = goodsimgs.substring(0,goodsimgs.length-1);
	        	layer.confirm('确定删除ID为'+ids+'供应商吗？',{icon:3, title:'提示信息'},function(index){
		            $.post("/goods/batchDeleteGoods",{
		            	batchIds : ids,  //将需要删除的id作为参数传入
		            	goodsimgs : imgs
		            },function(data){
		           	   tableIns.reload();
		           	   layer.msg(data.msg);
		               layer.close(index);
		            },"json");
		        }); 
		       break;
		    break;
		  };
		});
	  
	  table.on('tool(test)', function(obj){
		  var data = obj.data;
		  switch(obj.event){
		    case 'update':
		    	toUpdateGoods(data);
		    break;
		    case 'select':
		    	selectGoodsObj(data);
		    break;
		    case 'delete':
		    	layer.confirm('确定删除ID为'+data.id+'的商品吗？',{icon:3, title:'提示信息'},function(index){
		            $.post("/goods/deleteGoods",{
		                id : data.id,  //将需要删除的id作为参数传入
		                goodsimg:data.goodsimg
		            },function(data){
		           	   tableIns.reload();
		           	   layer.msg(data.msg);
		               layer.close(index); 
		            },"json");
		       });
		    break;
		  };
	  });
	  
	  var url;
	  var index;
	  function toAddGoods(){
		  	url="/goods/addGoods";
			index=layer.open({
				type:1,//弹出层的类型
				title:'添加商品',
				content:$("#editGoods"),  //type=1时使用
				skin:'layui-layer-lan',//设置皮肤
				area: ['800px', '600px'],//设置宽高
				shade:0.5,//设置遮罩的透明度
				shadeClose:true,//设置点击遮罩是否关闭弹出层
				maxmin:true, //是否显示最大化和最小化的按钮  该参数值对type:1和type:2有效
				success:function(){
					$("#dataFrm")[0].reset();
					//初始化下拉框
					initProviderSelect($("#providerid"));
					//设置默认图像
					$("#goodsimg_img").attr({src:'/file/download?path=defaultimg.png'});
					$("#goodsimg").val("defaultimg.png");
					fileUpload();
				}
			});
	  }
	  
	  function toUpdateGoods(data){
			url="/goods/updateGoods";
			index=layer.open({
				type:1,//弹出层的类型
				title:'修改商品',
				content:$("#editGoods"),  //type=1时使用
				skin:'layui-layer-molv',//设置皮肤
				area: ['800px', '600px'],//设置宽高
				shade:0.5,//设置遮罩的透明度
				shadeClose:true,//设置点击遮罩是否关闭弹出层
				maxmin:true, //是否显示最大化和最小化的按钮  该参数值对type:1和type:2有效
				success:function(){
					initProviderSelect($("#providerid"),function(){
                    	$("#providerid").val(data.providerid);
                    	form.render();
                    });
				    form.val("dataFrm",data);  
				    $("#goodsimg_img").attr({src:'/file/download?path='+data.goodsimg});
				    fileUpload();
				}
			});
	  }
	  
	  function fileUpload(){
		  var uploadInst = upload.render({
				elem : '#goodspath',
				url : '/file/uploadFile',
				accept:'images',
				acceptMime:'image/*',
				field:'mf',
				before : function(obj) {
					//预读本地文件示例，不支持ie8
					obj.preview(function(index, file,
							result) {
						alert(index+"--"+file+"--"+result);
						$('#goodsimg_img').attr('src', result); //图片链接（base64）
					});
				},
				done : function(res) {
					//如果上传失败
					if (res.code < 0) {
						return layer.msg('上传失败');
					}
					//上传成功
					$('#goodsimg').val(res.data.src);//设置要提交到数据库里面的路径
				},
				error : function() {
					//演示失败状态，并实现重传
					var goodsText = $('#goodsText');
					goodsText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-xs goods-reload">重试</a>');
					goodsText.find('.goods-reload').on(
							'click', function() {
								uploadInst.upload();
							});
				}
			});
	  }
	  
	  form.on('submit(doSubmit)', function(data){
		  var params = $("#dataFrm").serialize();
		 $.post(url,params,function(data){
				  tableIns.reload();
				  layer.msg(data.msg);
				  layer.close(index); //再执行关闭   
		  },"json"); 
		    
		  return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
		});
	  
	  function initProviderSelect(elem,fn){
		  $.post("/provider/loadAllProviderForList",function(data){
			  var html = "<option value=''>---请选择供应商---</option>";
			  for(var i=0;i<data.length;i++){
				  html+="<option value="+data[i].id+">"+data[i].providername+"</option>";
			  }
			  
			  elem.html(html);
			  if(fn!=undefined){
				  fn();
			  }
			  form.render();
		  },"json");
	  }
	});
</script>
</body>
</html>